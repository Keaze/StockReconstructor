package com.app.stock;

import com.app.history.model.MovementEreignis;
import com.app.history.model.MovementRecord;
import com.app.stock.model.StockRecord;
import com.app.utils.Result;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertNotNull;

class StockDataBulkTest {
    private List<MovementRecord> movements;

    @BeforeEach
    void setUp() {
        movements = List.of(
                MovementRecord.builder()
                        .lfdNr(1710682)
                        .bestandNr(10989198)
                        .lhmNr("4000046259L")
                        .platz("001PP0200000")
                        .artikelNr("102563")
                        .serienNr(null)
                        .charge1("43974")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(0.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.LOESCH)
                        .vgs(26)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("16:24:40")
                        .usr("KaMo")
                        .druckKnz("N")
                        .beleg1("001PP020000")
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1710681)
                        .bestandNr(10989198)
                        .lhmNr("4000046259L")
                        .platz("001PP0200000")
                        .artikelNr("102563")
                        .serienNr(null)
                        .charge1("43974")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(-2.00))
                        .mengeGesamt(BigDecimal.valueOf(0.00))
                        .gewichtAenderung(BigDecimal.valueOf(-0.27))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGAB)
                        .vgs(26)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("16:24:40")
                        .usr("KaMo")
                        .druckKnz("N")
                        .beleg1("001PP020000")
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1710680)
                        .bestandNr(10989198)
                        .lhmNr("4000046259L")
                        .platz("001PP0200000")
                        .artikelNr("102563")
                        .serienNr(null)
                        .charge1("43974")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(2.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(11)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("16:24:28")
                        .usr("KaMo")
                        .druckKnz("N")
                        .beleg1("client.verpackung.umbuchung")
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1709732)
                        .bestandNr(10989198)
                        .lhmNr("4000046259L")
                        .platz("001PP0100100")
                        .artikelNr("102563")
                        .serienNr(null)
                        .charge1("43974")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(2.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(11)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("12:51:35")
                        .usr("BaSi")
                        .druckKnz("N")
                        .beleg1("PZ0051189")
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1709731)
                        .bestandNr(10989198)
                        .lhmNr("4000046259L")
                        .platz("001BC0002000")
                        .artikelNr("102563")
                        .serienNr(null)
                        .charge1("43974")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(2.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(11)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("12:51:33")
                        .usr("BaSi")
                        .druckKnz("N")
                        .beleg1(null)
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1709671)
                        .bestandNr(10989198)
                        .lhmNr("4000046259L")
                        .platz("001AK0100000")
                        .artikelNr("102563")
                        .serienNr(null)
                        .charge1("43974")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(1.00))
                        .mengeGesamt(BigDecimal.valueOf(2.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.27))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGZU)
                        .vgs(25)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("11:53:33")
                        .usr("KAAC")
                        .druckKnz("N")
                        .beleg1("ELU0001829")
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build()
        );
    }


    @Test
    void testBulk() {
        StockData stockData = new StockData(new ArrayList<>());
        movements.forEach(movement -> stockData.handleMovement(Result.success(movement)));
        assertNotNull(stockData.getStockRecord(10989198));
        assertThat(stockData.getStockRecord(10989198).getMengeIst()).isEqualByComparingTo(BigDecimal.valueOf(1.00));
        assertThat(stockData.getStockRecord(10989198).getLhmNr()).isEqualTo("4000046259L");
        assertThat(stockData.getStockRecord(10989198).getPalNr()).isEqualTo("4000046259L");
        assertThat(stockData.getErrors()).isEmpty();
    }

    @Test
    void testBulkWareinMovements() {
        List<MovementRecord> movementRecords = List.of(
                MovementRecord.builder()
                        .lfdNr(1710364)
                        .bestandNr(9926874)
                        .lhmNr("3000026061")
                        .platz("1030100207")
                        .artikelNr("100446")
                        .serienNr(null)
                        .charge1("5A08125")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(408.00))
                        .mengeGesamt(BigDecimal.valueOf(408.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGZU)
                        .vgs(0)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("15:08:27")
                        .usr("DoBe")
                        .druckKnz("N")
                        .beleg1("9926874")
                        .beleg2("3000026061")
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1710363)
                        .bestandNr(9926874)
                        .lhmNr("3000026061")
                        .platz("1030100207")
                        .artikelNr("100446")
                        .serienNr(null)
                        .charge1("5A08125")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(-408.00))
                        .mengeGesamt(BigDecimal.valueOf(408.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGAB)
                        .vgs(0)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("15:08:27")
                        .usr("DoBe")
                        .druckKnz("N")
                        .beleg1("9926874")
                        .beleg2("3000026061")
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1710356)
                        .bestandNr(9926874)
                        .lhmNr("3000026061")
                        .platz("001BC0000600")
                        .artikelNr("100446")
                        .serienNr(null)
                        .charge1("5A08125")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(408.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(11)
                        .datum(LocalDate.parse("2026-02-19"))
                        .zeit("15:06:59")
                        .usr("DoBe")
                        .druckKnz("N")
                        .beleg1(null)
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1679775)
                        .bestandNr(9926874)
                        .lhmNr("3000026061")
                        .platz("1030100207")
                        .artikelNr("100446")
                        .serienNr(null)
                        .charge1("5A08125")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(408.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(10)
                        .datum(LocalDate.parse("2026-02-05"))
                        .zeit("08:50:22")
                        .usr("DoBe")
                        .druckKnz("N")
                        .beleg1(null)
                        .beleg2("001WE0000000")
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1679768)
                        .bestandNr(9926874)
                        .lhmNr("3000026061")
                        .platz("001BC0000600")
                        .artikelNr("100446")
                        .serienNr(null)
                        .charge1("5A08125")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(408.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(11)
                        .datum(LocalDate.parse("2026-02-05"))
                        .zeit("08:48:20")
                        .usr("DoBe")
                        .druckKnz("N")
                        .beleg1(null)
                        .beleg2(null)
                        .kdAuftragsNr(null)
                        .kdAuftragsPos(null)
                        .build()
        );

        StockRecord stockRecord = StockRecord.builder()
                .lfdNr(9926874)
                .artikelNr("100446")
                .mandant(250)
                .charge1("5A08125")
                .charge2("____________________")
                .serienNr(null)
                .kdAuftragsNr("____________________")
                .kdAuftragsPos("__________")
                .palNr("3000026061")
                .lhmNr("3000026061")
                .platz("1031900202")
                .mengeIst(BigDecimal.valueOf(408.00))
                .build();

        StockData stockData = new StockData(List.of(stockRecord));
        movementRecords.forEach(movement -> stockData.handleMovement(Result.success(movement)));

        assertNotNull(stockData.getStockRecord(9926874));
        assertThat(stockData.getErrors()).isEmpty();
        assertThat(stockData.getStockRecord(9926874).getMengeIst()).isEqualByComparingTo(BigDecimal.valueOf(408.00));
        assertThat(stockData.getStockRecord(9926874).getLhmNr()).isEqualTo("3000026061");
        assertThat(stockData.getStockRecord(9926874).getPalNr()).isEqualTo("3000026061");
        assertThat(stockData.getStockRecord(9926874).getPlatz()).isEqualTo("001BC0000600");
    }

    @Test
    void testBulkInventurMovements() {
        List<MovementRecord> movementRecords = List.of(
                MovementRecord.builder()
                        .lfdNr(1707018)
                        .bestandNr(10829822)
                        .lhmNr("9000047190")
                        .platz("001AK0000000")
                        .artikelNr("101190")
                        .serienNr(null)
                        .charge1("153748")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(9.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(14)
                        .datum(LocalDate.parse("2026-02-18"))
                        .zeit("13:14:50")
                        .usr("PiDu")
                        .druckKnz("N")
                        .beleg1("AKL Inventur")
                        .beleg2("Abschluss")
                        .kdAuftragsNr("____________________")
                        .kdAuftragsPos("____")
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1707017)
                        .bestandNr(10829822)
                        .lhmNr("9000047190")
                        .platz("001AK9900000")
                        .artikelNr("101190")
                        .serienNr(null)
                        .charge1("153748")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(9.00))
                        .mengeGesamt(BigDecimal.valueOf(9.00))
                        .gewichtAenderung(BigDecimal.valueOf(1.71))
                        .mandant(250)
                        .ereignis(MovementEreignis.MGKOZU)
                        .vgs(60)
                        .datum(LocalDate.parse("2026-02-18"))
                        .zeit("13:14:35")
                        .usr("PiDu")
                        .druckKnz("N")
                        .beleg1("Charge")
                        .beleg2("-")
                        .kdAuftragsNr("____________________")
                        .kdAuftragsPos("____")
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1707016)
                        .bestandNr(10829822)
                        .lhmNr("9000047190")
                        .platz("001AK9900000")
                        .artikelNr("101190")
                        .serienNr(null)
                        .charge1("153748;25L1069")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(-9.00))
                        .mengeGesamt(BigDecimal.valueOf(9.00))
                        .gewichtAenderung(BigDecimal.valueOf(-1.71))
                        .mandant(250)
                        .ereignis(MovementEreignis.MGKOAB)
                        .vgs(60)
                        .datum(LocalDate.parse("2026-02-18"))
                        .zeit("13:14:35")
                        .usr("PiDu")
                        .druckKnz("N")
                        .beleg1("Charge")
                        .beleg2("-")
                        .kdAuftragsNr("____________________")
                        .kdAuftragsPos("____")
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1707003)
                        .bestandNr(10829822)
                        .lhmNr("9000047190")
                        .platz("001AK9900000")
                        .artikelNr("101190")
                        .serienNr(null)
                        .charge1("153748;25L1069")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(9.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(14)
                        .datum(LocalDate.parse("2026-02-18"))
                        .zeit("13:04:15")
                        .usr("PiDu")
                        .druckKnz("N")
                        .beleg1("AKL-Inventur")
                        .beleg2("Auslagerung")
                        .kdAuftragsNr("____________________")
                        .kdAuftragsPos("____")
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1704511)
                        .bestandNr(10829822)
                        .lhmNr("9000047190")
                        .platz("001AK0000000")
                        .artikelNr("101190")
                        .serienNr(null)
                        .charge1("153748;25L1069")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(9.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(10)
                        .datum(LocalDate.parse("2026-02-17"))
                        .zeit("13:51:44")
                        .usr("ToLa")
                        .druckKnz("N")
                        .beleg1(null)
                        .beleg2("001WE0000000")
                        .kdAuftragsNr("____________________")
                        .kdAuftragsPos("____")
                        .build(),
                MovementRecord.builder()
                        .lfdNr(1704510)
                        .bestandNr(10829822)
                        .lhmNr("9000047190")
                        .platz("001BC0001700")
                        .artikelNr("101190")
                        .serienNr(null)
                        .charge1("153748;25L1069")
                        .charge2("____________________")
                        .mengeAenderung(BigDecimal.valueOf(0.00))
                        .mengeGesamt(BigDecimal.valueOf(9.00))
                        .gewichtAenderung(BigDecimal.valueOf(0.00))
                        .mandant(250)
                        .ereignis(MovementEreignis.BEWGNG)
                        .vgs(11)
                        .datum(LocalDate.parse("2026-02-17"))
                        .zeit("13:51:39")
                        .usr("ToLa")
                        .druckKnz("N")
                        .beleg1(null)
                        .beleg2(null)
                        .kdAuftragsNr("____________________")
                        .kdAuftragsPos("____")
                        .build()
        );

        StockRecord stockRecord = StockRecord.builder()
                .lfdNr(10829822)
                .artikelNr("101190")
                .mandant(250)
                .charge1("153748")
                .charge2("____________________")
                .serienNr(null)
                .kdAuftragsNr("____________________")
                .kdAuftragsPos("__________")
                .palNr("9000047190")
                .lhmNr("9000047190")
                .platz("001BC0001700")
                .mengeIst(BigDecimal.valueOf(9.00))
                .build();

        StockData stockData = new StockData(List.of(stockRecord));
        movementRecords.forEach(movement -> stockData.handleMovement(Result.success(movement)));

        assertNotNull(stockData.getStockRecord(10829822));
        assertThat(stockData.getErrors()).isEmpty();
        assertThat(stockData.getStockRecord(10829822).getMengeIst()).isEqualByComparingTo(BigDecimal.valueOf(9.00));
        assertThat(stockData.getStockRecord(10829822).getLhmNr()).isEqualTo("9000047190");
        assertThat(stockData.getStockRecord(10829822).getPalNr()).isEqualTo("9000047190");
        assertThat(stockData.getStockRecord(10829822).getPlatz()).isEqualTo("001BC0001700");
    }
}
